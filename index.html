<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>סיפורי שימי</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to the external stylesheet -->
    <link rel="stylesheet" href="style.css">
    <!-- All custom styles have been moved to style.css -->
</head>

<body>
    <div class="container">
       <!-- Home Page Section -->
       <div id="homePageSection" class="home-page-section">
        <div class="home-page-section-title">
            <h2>!ברוכים הבאים לסיפורי שימי</h2>
        </div>
        <div class="home-button-container">
            <button id="goToDispenserBtn" class="home-button">לסיפורים</button>
        </div>
    </div>

    <!-- Phrase Dispenser Section (Initially Hidden) -->
    <div id="phraseDispenserSection" class="phrase-dispenser-section">
        <div class="content-wrapper">
            <div id="phraseDisplay" class="phrase-display">
                <!-- Initial phrase or prompt will be loaded here by JavaScript -->
            </div>
            <!-- Image loader element -->
            <div>
                <img id="imageLoader" src="shimiThinkingSmall.jpeg" alt="Loading Spinner" class="image-loader">
            </div>
        </div>
        <div class="home-button-container"> <!-- Reusing this class for button grouping -->
            <button id="choosePhraseBtn" class="choose-button">
                !תביא סיפור
            </button>
            <button id="backToHomeBtn" class="choose-button">
                ראשי
            </button>
        </div>
    </div>

    <script>
        // *** This is the correct Google Visualization API endpoint for your sheet ***
        // Sheet ID: 2PACX-1vRwCxbj6L8iXZPtbiBe2Vq41d2shBjpis2CjsnYFYrD7BsaMJPuiTQ67FW1QlEpFeqQVJLhy3tkBrAb
        // GID: 0
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/2PACX-1vRwCxbj6L8iXZPtbiBe2Vq41d2shBjpis2CjsnYFYrD7BsaMJPuiTQ67FW1QlEpFeqQVJLhy3tkBrAb/gviz/tq?tqx=out:json&tq&gid=0';

        let phrases = []; // This will now be populated from the Google Sheet
        let displayedPhraseIndices = []; // Array to keep track of indices of phrases that have already been displayed

        // Function to fetch phrases from Google Sheet
        async function fetchPhrases() {
            try {
                // Show loader while fetching
                phraseDisplay.style.display = 'none';
                imageLoader.classList.add('spinning');

                const response = await fetch(GOOGLE_SHEET_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text(); // Get as text first
                // Google's JSON output from gviz/tq endpoint has a prefix like "/*O_o*/\ngoogle.visualization.Query.setResponse({"
                // We need to strip that to get pure JSON
                const jsonString = text.replace(/^.*\n/, '').replace(/\);$/, ''); // Remove prefix and suffix

                const data = JSON.parse(jsonString);

                // Access the rows and columns based on the typical Google Visualization JSON structure
                const cols = data.table.cols;
                const rows = data.table.rows;

                phrases = rows.map(row => {
                    const phraseIndex = cols.findIndex(col => col.label === 'phrase');
                    const urlIndex = cols.findIndex(col => col.label === 'url');

                    return {
                        phrase: row.c[phraseIndex] ? row.c[phraseIndex].v : '',
                        url: row.c[urlIndex] ? row.c[urlIndex].v : '' // Handle cases where URL might be empty
                    };
                }).filter(item => item.phrase.trim() !== ''); // Filter out empty phrases

                console.log("Phrases loaded from Google Sheet:", phrases);

                // Once phrases are loaded, hide loader and display the first one
                imageLoader.classList.remove('spinning');
                phraseDisplay.style.display = 'flex';

                if (phrases.length > 0) {
                    displayRandomPhrase();
                } else {
                    phraseDisplay.textContent = "No phrases found in Google Sheet.";
                }

            } catch (error) {
                console.error("Error fetching phrases:", error);
                phraseDisplay.textContent = "Failed to load phrases. Check console for details.";
                imageLoader.classList.remove('spinning'); // Stop spinning on error
                phraseDisplay.style.display = 'flex';
            }
        }

        // Get references to the HTML elements
        const homePageSection = document.getElementById('homePageSection');
        const phraseDispenserSection = document.getElementById('phraseDispenserSection');
        const goToDispenserBtn = document.getElementById('goToDispenserBtn');
        const backToHomeBtn = document.getElementById('backToHomeBtn'); // Reference to the new back button

        const choosePhraseBtn = document.getElementById('choosePhraseBtn');
        const phraseDisplay = document.getElementById('phraseDisplay');
        const imageLoader = document.getElementById('imageLoader'); // Reference to the image loader

        // Function to display a random phrase and its URL
        function displayRandomPhrase() {
            // Hide phrase content
            phraseDisplay.style.display = 'none';

            // Add 'spinning' class to start animation
            imageLoader.classList.add('spinning');

            // Simulate loading time for 2 seconds
            setTimeout(() => {
                // Remove 'spinning' class to stop animation
                imageLoader.classList.remove('spinning');

                // Show phrase content
                phraseDisplay.style.display = 'flex'; // Restore display for phrase

                // If all phrases have been displayed, reset the array to start a new cycle
                if (displayedPhraseIndices.length === phrases.length) {
                    displayedPhraseIndices = []; // Reset the stack
                    console.log("All phrases displayed. Resetting stack."); // Optional: log to console
                }

                let randomIndex;
                let randomPhraseObject;
                let isDuplicate;

                // Loop until a unique phrase (index not yet displayed) is found
                // Ensure there are phrases to pick from
                if (phrases.length === 0) {
                    phraseDisplay.textContent = "No phrases available.";
                    return;
                }

                do {
                    randomIndex = Math.floor(Math.random() * phrases.length);
                    randomPhraseObject = phrases[randomIndex];
                    isDuplicate = displayedPhraseIndices.includes(randomIndex);
                } while (isDuplicate);

                // Add the chosen unique index to the list of displayed phrases
                displayedPhraseIndices.push(randomIndex);

                // Clear previous content
                phraseDisplay.innerHTML = '';

                // Check if the phrase object has a URL
                if (randomPhraseObject.url && randomPhraseObject.url.trim() !== '') {
                    // Create a clickable link for the phrase/title
                    const phraseLink = document.createElement('a');
                    phraseLink.href = randomPhraseObject.url;
                    phraseLink.textContent = randomPhraseObject.phrase;
                    phraseLink.target = "_blank"; // Open link in a new tab
                    phraseLink.classList.add('phrase-link'); // Add a class for styling if needed
                    phraseDisplay.appendChild(phraseLink);
                } else {
                    // If no URL, just display the phrase as text
                    phraseDisplay.textContent = randomPhraseObject.phrase;
                }

            }, 2000); // 2000 milliseconds = 2 seconds
        }

        // Event listener for the "Go to Dispenser" button
        goToDispenserBtn.addEventListener('click', () => {
            homePageSection.style.display = 'none'; // Hide home page
            phraseDispenserSection.style.display = 'flex'; // Show phrase dispenser
            // Instead of directly calling displayRandomPhrase, fetch phrases first
            fetchPhrases(); // Call fetchPhrases to load data from Google Sheet
        });

        // Add an event listener to the "Choose Phrase" button (inside phrase dispenser)
        choosePhraseBtn.addEventListener('click', displayRandomPhrase);

        // Event listener for the "Back to Home" button
        backToHomeBtn.addEventListener('click', () => {
            homePageSection.style.display = 'flex'; // Show home page
            phraseDispenserSection.style.display = 'none'; // Hide phrase dispenser
            // displayedPhraseIndices is NOT reset here, preserving the story count.
        });

        // Initial setup: Show home page, hide phrase dispenser
        document.addEventListener('DOMContentLoaded', () => {
            homePageSection.style.display = 'flex'; // Ensure home page is visible
            phraseDispenserSection.style.display = 'none'; // Hide phrase dispenser
        });
    </script>
</body>

</html>
